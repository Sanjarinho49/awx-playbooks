---
- name: Install Roles, Features etc.
  hosts: all
  tasks:  
  - name: create windows users
    win_user:
      name: Ansible
      password: "{{ ansible_pw }}"
      state: present
      groups: 
        - Users
        - Administrators
        
 # - name: Install IIS (Web-Server only)
 #   ansible.windows.win_feature:
 ##     name: Web-Server
  #    state: present

 # - name: Install IIS (Web-Server and Web-Common-Http)
 #   ansible.windows.win_feature:
 #     name:
 #     - Web-Server
  #    - Web-Common-Http
 #     state: present

  - name: Install NET-Framework-Core from file
    ansible.windows.win_feature:
      name: NET-Framework-Core
      source: C:\Support\sxs
      state: present

  - name: Install IIS Web-Server with sub features and management tools
    ansible.windows.win_feature:
      name: "NET-Framework-Features,NET-Framework-Core,NET-HTTP-Activation,NET-Framework-45-Features,NET-Framework-45-Core,NET-Framework-45-ASPNET,NET-WCF-Services45,NET-WCF-HTTP-Activation45,Server-Media-Foundation,Windows-Identity-Foundation,Windows-Server-Backup,Web-Common-Http,Web-Default-Doc,Web-Dir-Browsing,Web-Http-Errors,Web-Static-Content,Web-Http-Redirect,Web-Health,Web-Http-Logging,Web-Log-Libraries,Web-Request-Monitor,Web-Http-Tracing,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Security,Web-Filtering,Web-Basic-Auth,Web-CertProvider,Web-Client-Auth,Web-Digest-Auth,Web-Cert-Auth,Web-IP-Security,	Web-Url-Auth,Web-Windows-Auth,Web-App-Dev,Web-Net-Ext,Web-Net-Ext45,Web-AppInit,Web-ASP,Web-Asp-Net,Web-Asp-Net45,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Includes,Web-WebSockets,Web-Mgmt-Tools,Web-Scripting-Tools,Windows-Server-Backup,PowerShellRoot,PowerShell,PowerShell-V2"
      #PowerShell_ise is not listed
      state: present
      include_sub_features: no
      include_management_tools: yes
    register: win_feature

  - name: Reboot if installing Web-Server feature requires it
    ansible.windows.win_reboot:
    when: win_feature.reboot_required

  - name: Setup Active Directory Controller
    win_domain:
      dns_domain_name: "{{ dns_domain_name }}"
      safe_mode_password: "{{ safe_mode_password }}"
    register: active_directory_controllers
 
  - name: reboot once DC created
    win_reboot:
    when: active_directory_controllers.reboot_required

    
  - name: Promote server as a read only domain controller
    ansible.windows.win_domain_controller:
      dns_domain_name: "{{ dns_domain_name }}"
      domain_admin_user: "{{ domain_admin_user }}"
      domain_admin_password: "{{ domain_admin_password }}"
      safe_mode_password: "{{ safe_mode_password }}"
      state: domain_controller
      read_only: yes
      site_name: "{{ site_name }}"
    register: dc_promotion
      
  - name: Reboot after promotion
    ansible.windows.win_reboot:
    when: dc_promotion.reboot_required

